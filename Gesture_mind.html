<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GestureMind: An accessible audio-based game for the blind with customizable sounds.">
    <title>GestureMind - Enhanced Accessible Audio Game</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        :root {
            --primary-color: #4CAF50;
            --hover-color: #45a049;
            --background-dark: #222;
            --text-light: #fff;
            --swipe-area: #87CEEB;
            --dialog-bg: rgba(0, 0, 0, 0.8);
            --button-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            --success-bg: #90EE90;
            --fail-bg: #FF6347;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-dark);
            color: var(--text-light);
            text-align: center;
            user-select: none;
            overflow: hidden;
        }
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            transition: opacity 0.5s ease-in-out;
            position: relative;
        }
        .screen.active {
            display: flex;
        }
        button {
            padding: 12px 24px;
            font-size: 1.125rem;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px;
            box-shadow: var(--button-shadow);
        }
        button:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
        }
        #optionsButton {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }
        .navigate-up {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
        }
        #swipeArea {
            width: 90%;
            max-width: 400px;
            height: 300px;
            background-color: var(--swipe-area);
            font-size: 1.25rem;
            line-height: 300px;
            margin: 20px auto;
            border: 2px solid #000;
            border-radius: 10px;
            box-shadow: var(--button-shadow);
            touch-action: none;
            transition: background-color 0.5s ease;
        }
        .floatingDialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dialog-bg);
            color: var(--text-light);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--button-shadow);
            z-index: 2000;
            text-align: center;
        }
        .dialogBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1500;
        }
        #progressBar {
            width: 80%;
            max-width: 300px;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px auto;
        }
        #progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 100%;
            transition: width 1s linear;
        }
        #profileStats p, .audio-setting {
            margin: 10px 0;
            font-size: 1.1rem;
        }
        .audio-setting select {
            width: 100px;
            padding: 5px;
            margin-left: 10px;
        }
        .audio-setting button {
            padding: 5px 10px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Main Screen -->
    <div id="mainScreen" class="screen active" role="main" aria-labelledby="mainTitle">
        <h1 id="mainTitle">GestureMind</h1>
        <p id="currentLevelDisplay">Current Level: 1</p>
        <button id="optionsButton" onclick="showOptions()" aria-label="Additional Options">☰</button>
        <button onclick="startGame()" aria-label="Start New Game">Start Game</button>
        <button id="continueButton" onclick="startGame(userData.currentLevel)" aria-label="Continue with Current Level" style="display: none;">Continue with Level</button>
        <button onclick="startGame(1)" aria-label="Restart from Level 1">Restart from Level 1</button>
        <button onclick="showTutorial()" aria-label="View Tutorial">Tutorial</button>
    </div>

    <!-- Options Screen -->
    <div id="optionsScreen" class="screen" role="dialog" aria-labelledby="optionsTitle">
        <button class="navigate-up" onclick="hideOptions()" aria-label="Back to Main Menu">↑</button>
        <h2 id="optionsTitle">Options</h2>
        <button onclick="showUserProfile()" aria-label="View User Profile">Profile</button>
        <button onclick="showSoundSettings()" aria-label="Manage Audio Settings">Manage Sound & Effects</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen" role="region" aria-labelledby="gameTitle">
        <h2 id="gameTitle">Game On! Level <span id="gameLevel">1</span></h2>
        <div id="swipeArea" aria-label="Swipe area, listen for audio cue and respond">Swipe or Use Arrow Keys</div>
        <p id="score">Score: 0</p>
        <p id="timer">Time Left: 180s</p>
        <p id="turnTimer">Turn Time: 5s</p>
        <div id="progressBar" role="progressbar" aria-valuenow="180" aria-valuemin="0" aria-valuemax="180" aria-label="Game Progress">
            <div id="progress"></div>
        </div>
        <button id="pauseButton" onclick="toggleGamePause()" aria-label="Pause Game">Pause</button>
        <button onclick="endGame()" aria-label="Stop Game">Stop Game</button>
    </div>

    <!-- User Profile Screen -->
    <div id="profileScreen" class="screen" role="dialog" aria-labelledby="profileTitle">
        <button class="navigate-up" onclick="hideProfile()" aria-label="Back to Options">↑</button>
        <h2 id="profileTitle">User Profile</h2>
        <label for="userName">Name:</label>
        <input type="text" id="userName" aria-label="Enter your name" placeholder="Player">
        <div id="profileStats" aria-label="Profile Statistics"></div>
        <button onclick="saveProfile()" aria-label="Save Profile Changes">Save</button>
        <button onclick="deleteProfile()" aria-label="Delete Profile">Delete Profile</button>
    </div>

    <!-- Sound Settings Screen -->
    <div id="soundSettingsScreen" class="screen" role="dialog" aria-labelledby="soundSettingsTitle">
        <button class="navigate-up" onclick="hideSoundSettings()" aria-label="Back to Options">↑</button>
        <h2 id="soundSettingsTitle">Manage Sound & Effects</h2>
        <div class="audio-setting">
            <label for="bgmVolume">Background Music Volume:</label>
            <select id="bgmVolume" aria-label="Adjust Background Music Volume"></select>
            <button onclick="previewAudio('bgm')" aria-label="Preview Background Music">Preview</button>
            <button id="bgmPause" onclick="pausePreview('bgm')" aria-label="Pause Background Music Preview" style="display: none;">Pause</button>
            <input type="file" id="bgmFile" accept="audio/*" aria-label="Upload Custom Background Music">
            <button onclick="removeCustomSound('bgm')" aria-label="Remove Custom Background Music">Remove</button>
            <label><input type="checkbox" id="bgmLoop" checked> Loop</label>
        </div>
        <div class="audio-setting">
            <label for="mainScreenVolume">Main Screen Volume:</label>
            <select id="mainScreenVolume" aria-label="Adjust Main Screen Volume"></select>
            <button onclick="previewAudio('mainScreen')" aria-label="Preview Main Screen Sound">Preview</button>
            <button id="mainScreenPause" onclick="pausePreview('mainScreen')" aria-label="Pause Main Screen Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="mainScreenFile" accept="audio/*" aria-label="Upload Custom Main Screen Sound">
            <button onclick="removeCustomSound('mainScreen')" aria-label="Remove Custom Main Screen Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="pauseVolume">Pause Volume:</label>
            <select id="pauseVolume" aria-label="Adjust Pause Volume"></select>
            <button onclick="previewAudio('pause')" aria-label="Preview Pause Sound">Preview</button>
            <button id="pausePause" onclick="pausePreview('pause')" aria-label="Pause Pause Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="pauseFile" accept="audio/*" aria-label="Upload Custom Pause Sound">
            <button onclick="removeCustomSound('pause')" aria-label="Remove Custom Pause Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="resetVolume">Reset Volume:</label>
            <select id="resetVolume" aria-label="Adjust Reset Volume"></select>
            <button onclick="previewAudio('reset')" aria-label="Preview Reset Sound">Preview</button>
            <button id="resetPause" onclick="pausePreview('reset')" aria-label="Pause Reset Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="resetFile" accept="audio/*" aria-label="Upload Custom Reset Sound">
            <button onclick="removeCustomSound('reset')" aria-label="Remove Custom Reset Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="swipeUpVolume">Swipe Up Volume:</label>
            <select id="swipeUpVolume" aria-label="Adjust Swipe Up Volume"></select>
            <button onclick="previewAudio('up')" aria-label="Preview Swipe Up Sound">Preview</button>
            <button id="swipeUpPause" onclick="pausePreview('up')" aria-label="Pause Swipe Up Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="swipeUpFile" accept="audio/*" aria-label="Upload Custom Swipe Up Sound">
            <button onclick="removeCustomSound('up')" aria-label="Remove Custom Swipe Up Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="swipeDownVolume">Swipe Down Volume:</label>
            <select id="swipeDownVolume" aria-label="Adjust Swipe Down Volume"></select>
            <button onclick="previewAudio('down')" aria-label="Preview Swipe Down Sound">Preview</button>
            <button id="swipeDownPause" onclick="pausePreview('down')" aria-label="Pause Swipe Down Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="swipeDownFile" accept="audio/*" aria-label="Upload Custom Swipe Down Sound">
            <button onclick="removeCustomSound('down')" aria-label="Remove Custom Swipe Down Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="swipeLeftVolume">Swipe Left Volume:</label>
            <select id="swipeLeftVolume" aria-label="Adjust Swipe Left Volume"></select>
            <button onclick="previewAudio('left')" aria-label="Preview Swipe Left Sound">Preview</button>
            <button id="swipeLeftPause" onclick="pausePreview('left')" aria-label="Pause Swipe Left Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="swipeLeftFile" accept="audio/*" aria-label="Upload Custom Swipe Left Sound">
            <button onclick="removeCustomSound('left')" aria-label="Remove Custom Swipe Left Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="swipeRightVolume">Swipe Right Volume:</label>
            <select id="swipeRightVolume" aria-label="Adjust Swipe Right Volume"></select>
            <button onclick="previewAudio('right')" aria-label="Preview Swipe Right Sound">Preview</button>
            <button id="swipeRightPause" onclick="pausePreview('right')" aria-label="Pause Swipe Right Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="swipeRightFile" accept="audio/*" aria-label="Upload Custom Swipe Right Sound">
            <button onclick="removeCustomSound('right')" aria-label="Remove Custom Swipe Right Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="successVolume">Success Volume:</label>
            <select id="successVolume" aria-label="Adjust Success Volume"></select>
            <button onclick="previewAudio('success')" aria-label="Preview Success Sound">Preview</button>
            <button id="successPause" onclick="pausePreview('success')" aria-label="Pause Success Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="successFile" accept="audio/*" aria-label="Upload Custom Success Sound">
            <button onclick="removeCustomSound('success')" aria-label="Remove Custom Success Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="failVolume">Fail Volume:</label>
            <select id="failVolume" aria-label="Adjust Fail Volume"></select>
            <button onclick="previewAudio('fail')" aria-label="Preview Fail Sound">Preview</button>
            <button id="failPause" onclick="pausePreview('fail')" aria-label="Pause Fail Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="failFile" accept="audio/*" aria-label="Upload Custom Fail Sound">
            <button onclick="removeCustomSound('fail')" aria-label="Remove Custom Fail Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="alertVolume">Alert Volume:</label>
            <select id="alertVolume" aria-label="Adjust Alert Volume"></select>
            <button onclick="previewAudio('alert')" aria-label="Preview Alert Sound">Preview</button>
            <button id="alertPause" onclick="pausePreview('alert')" aria-label="Pause Alert Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="alertFile" accept="audio/*" aria-label="Upload Custom Alert Sound">
            <button onclick="removeCustomSound('alert')" aria-label="Remove Custom Alert Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="winVolume">Win Volume:</label>
            <select id="winVolume" aria-label="Adjust Win Volume"></select>
            <button onclick="previewAudio('win')" aria-label="Preview Win Sound">Preview</button>
            <button id="winPause" onclick="pausePreview('win')" aria-label="Pause Win Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="winFile" accept="audio/*" aria-label="Upload Custom Win Sound">
            <button onclick="removeCustomSound('win')" aria-label="Remove Custom Win Sound">Remove</button>
        </div>
        <div class="audio-setting">
            <label for="fallVolume">Fall Volume:</label>
            <select id="fallVolume" aria-label="Adjust Fall Volume"></select>
            <button onclick="previewAudio('fall')" aria-label="Preview Fall Sound">Preview</button>
            <button id="fallPause" onclick="pausePreview('fall')" aria-label="Pause Fall Sound Preview" style="display: none;">Pause</button>
            <input type="file" id="fallFile" accept="audio/*" aria-label="Upload Custom Fall Sound">
            <button onclick="removeCustomSound('fall')" aria-label="Remove Custom Fall Sound">Remove</button>
        </div>
        <button onclick="hideSoundSettings()" aria-label="Return to Options">Back</button>
    </div>

    <!-- Tutorial Screen -->
    <div id="tutorialScreen" class="screen" role="dialog" aria-labelledby="tutorialTitle">
        <button class="navigate-up" onclick="hideTutorial()" aria-label="Back to Main Menu">↑</button>
        <h2 id="tutorialTitle">GestureMind Tutorial</h2>
        <div id="tutorialContent" style="text-align: left; max-width: 600px; margin: 20px auto;"></div>
        <button onclick="hideTutorial()" aria-label="Back to Main Menu">Back</button>
    </div>

    <!-- Audio Elements -->
    <audio id="gameBGM" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Game%20BGM.mp3" preload="auto" loop></audio>
    <audio id="mainScreenSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Main%20screen%20(1).mp3" preload="auto"></audio>
    <audio id="pauseSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Pause.ogg" preload="auto"></audio>
    <audio id="resetSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Reset.ogg" preload="auto"></audio>
    <audio id="swipeUpCue" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20up.%20.mp3" preload="auto"></audio>
    <audio id="swipeDownCue" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20down.%20.mp3" preload="auto"></audio>
    <audio id="swipeLeftCue" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20backward.%20.mp3" preload="auto"></audio>
    <audio id="swipeRightCue" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20forward.%20.mp3" preload="auto"></audio>
    <audio id="successSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/shoot.wav" preload="auto"></audio>
    <audio id="failSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/miss.wav" preload="auto"></audio>
    <audio id="alertSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/alert%201%201.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/celebration.mp3" preload="auto"></audio>
    <audio id="fallSound" src="https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/foul.wav" preload="auto"></audio>

    <script>
        'use strict';

        let score = 0;
        let totalTime = 180;
        let turnTime = 5;
        let gameInterval, turnInterval;
        let isGamePaused = false;
        let isAudioPlaying = false;
        let isGameActive = false;
        let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
        let currentCues = [];
        let currentLevel = 1;
        let swipeCount = 0;
        let startTime = 0;
        let lastSpokenScore = 0;
        const maxLevels = 5;
        const swipeArea = document.getElementById("swipeArea");
        const cues = ["up", "down", "left", "right"];
        const audioElements = {
            bgm: document.getElementById("gameBGM"),
            mainScreen: document.getElementById("mainScreenSound"),
            pause: document.getElementById("pauseSound"),
            reset: document.getElementById("resetSound"),
            up: document.getElementById("swipeUpCue"),
            down: document.getElementById("swipeDownCue"),
            left: document.getElementById("swipeLeftCue"),
            right: document.getElementById("swipeRightCue"),
            success: document.getElementById("successSound"),
            fail: document.getElementById("failSound"),
            alert: document.getElementById("alertSound"),
            win: document.getElementById("winSound"),
            fall: document.getElementById("fallSound")
        };

        let userData = {
            name: "Player",
            currentLevel: 1,
            correctSwipes: 0,
            missedSwipes: 0,
            totalScore: 0,
            matchesWon: 0,
            matchesLost: 0,
            totalTimeTaken: 0,
            gamesPlayed: 0,
            levelScores: {},
            customSounds: {},
            volumes: {}
        };

        const defaultAudioSources = {
            bgm: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Game%20BGM.mp3",
            mainScreen: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Main%20screen%20(1).mp3",
            pause: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Pause.ogg",
            reset: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Reset.ogg",
            up: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20up.%20.mp3",
            down: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20down.%20.mp3",
            left: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20backward.%20.mp3",
            right: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Swipe%20forward.%20.mp3",
            success: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/shoot.wav",
            fail: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/miss.wav",
            alert: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/alert%201%201.mp3",
            win: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/celebration.mp3",
            fall: "https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/foul.wav"
        };

        const winMessages = [
            "Fantastic Victory! You’re Unstoppable!",
            "You’re a Swipe Master! Well Done!",
            "Brilliant Win! Keep the Streak Going!",
            "Awesome Job! You Nailed It!",
            "Victory is Yours! Amazing Skills!"
        ];

        const loseMessages = [
            "Oh No, Tough Luck! Try Again, Champ!",
            "Don’t Give Up, Dear! You’ll Get It Next Time!",
            "Aww, So Close! Let’s Bounce Back!",
            "No Worries, Friend! Another Shot Awaits!",
            "Game Over, But Your Spirit’s Strong! Retry?"
        ];

        const tutorialData = {
            "Introduction": {
                "title": "Welcome to GestureMind",
                "description": "GestureMind is an audio-based game designed for accessibility, especially for visually impaired players. The game challenges you to respond to audio cues with swipes or key presses within a time limit."
            },
            "Objective": {
                "title": "Game Objective",
                "description": "Your goal is to score at least 80 points within 3 minutes (180 seconds) to win the game. However, to advance to the next level, you must achieve a perfect score of 100 points in the current level."
            },
            "Controls": {
                "title": "How to Play",
                "description": "Listen to the audio cues and respond accordingly:",
                "details": [
                    {"action": "Swipe Up or Press Arrow Up", "cue": "Swipe up audio", "purpose": "Respond to the 'Swipe Up' cue."},
                    {"action": "Swipe Down or Press Arrow Down", "cue": "Swipe down audio", "purpose": "Respond to the 'Swipe Down' cue."},
                    {"action": "Swipe Left or Press Arrow Left", "cue": "Swipe backward audio", "purpose": "Respond to the 'Swipe Left' cue."},
                    {"action": "Swipe Right or Press Arrow Right", "cue": "Swipe forward audio", "purpose": "Respond to the 'Swipe Right' cue."}
                ]
            },
            "Gameplay Mechanics": {
                "title": "Gameplay Rules",
                "description": "Understand the core mechanics to succeed:",
                "details": [
                    {"rule": "Turn Time", "description": "You have 5 seconds per turn to respond to each cue after the audio finishes."},
                    {"rule": "Scoring", "description": "Correct swipe: +1.5 points. Incorrect or missed swipe: -0.5 points (minimum score is 0)."},
                    {"rule": "Levels", "description": "Level 1 has 1 cue per turn. Higher levels (up to 3 cues) increase difficulty with no gap between cues. You must score 100 points to unlock the next level."},
                    {"rule": "Winning", "description": "Score 80+ points within 180 seconds to win. Score 100 points to advance."},
                    {"rule": "Audio Cues", "description": "Level 1 cues play sequentially. Levels 2-5 cues play back-to-back with no gap."}
                ]
            },
            "Screens": {
                "title": "Navigating the Game",
                "description": "Explore the different screens:",
                "details": [
                    {"screen": "Main Screen", "description": "Start a new game, continue from your current level, restart from Level 1, or view the tutorial."},
                    {"screen": "Options", "description": "Access your profile or sound settings."},
                    {"screen": "Profile", "description": "View and edit your name and stats (saved permanently until deleted)."},
                    {"screen": "Sound Settings", "description": "Adjust volumes, upload custom sounds (saved until deleted), and preview audio effects."},
                    {"screen": "Game Screen", "description": "Play the game, pause, or stop. Displays score, total time, and turn time."}
                ]
            },
            "Tips": {
                "title": "Tips for Success",
                "description": "Maximize your performance with these strategies:",
                "details": [
                    {"tip": "Practice Timing", "description": "Respond quickly within the 5-second turn time after the audio ends."},
                    {"tip": "Memorize Cues", "description": "Learn the audio cues to react faster, especially in higher levels with back-to-back cues."},
                    {"tip": "Use Arrow Keys", "description": "If swiping is tricky, use arrow keys for precise control."},
                    {"tip": "Customize Sounds", "description": "Upload familiar audio files in Sound Settings to make cues easier to recognize (saved until deleted)."}
                ]
            }
        };

        const speak = (text) => {
            if (!isAudioPlaying) {
                const audio = new Audio(`https://api.streamelements.com/kappa/v2/speech?voice=Aditi&text=${encodeURIComponent(text)}`);
                audio.play().catch(err => console.error("TTS Error:", err));
            }
        };

        const setScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            if (screenId !== "none") {
                document.getElementById(screenId).classList.add('active');
            }
        };

        const saveUserData = () => {
            localStorage.setItem("gestureMindUserData", JSON.stringify(userData));
        };

        const loadUserData = () => {
            const savedData = localStorage.getItem("gestureMindUserData");
            if (savedData) {
                userData = JSON.parse(savedData);
                applyCustomSounds();
                applyVolumes();
            }
            updateMainScreen();
        };

        const applyCustomSounds = () => {
            for (const [key, url] of Object.entries(userData.customSounds)) {
                if (audioElements[key] && url) {
                    audioElements[key].src = url;
                }
            }
            audioElements.bgm.loop = document.getElementById("bgmLoop").checked;
        };

        const applyVolumes = () => {
            for (const [key, volume] of Object.entries(userData.volumes)) {
                if (audioElements[key]) {
                    audioElements[key].volume = volume;
                }
            }
        };

        const clearDialogs = () => {
            document.querySelectorAll('.floatingDialog, .dialogBackdrop').forEach(el => el.remove());
        };

        const playCue = () => {
            if (!isGameActive) return;
            currentCues = [];
            swipeCount = 0;
            const numCues = currentLevel === 1 ? 1 : Math.min(currentLevel, 3);
            for (let i = 0; i < numCues; i++) {
                currentCues.push(cues[Math.floor(Math.random() * cues.length)]);
            }
            turnTime = 5;
            updateUI();
            clearInterval(turnInterval);
            playNextCue(0);
        };

        const playNextCue = (index) => {
            if (!isGameActive || index >= currentCues.length) {
                if (index === currentCues.length) {
                    turnInterval = setInterval(turnLoop, 1000); // Start countdown after all cues
                }
                return;
            }
            const audio = audioElements[currentCues[index]];
            isAudioPlaying = true;
            audio.currentTime = 0;
            audio.play().then(() => {
                audio.onended = () => {
                    isAudioPlaying = false;
                    playNextCue(index + 1); // Play next cue immediately after current one ends
                };
            }).catch(err => {
                console.error(`Failed to play ${currentCues[index]} audio:`, err);
                isAudioPlaying = false;
                playNextCue(index + 1);
            });
        };

        const startGame = (level = 1) => {
            if (level > userData.currentLevel && (!userData.levelScores[userData.currentLevel] || userData.levelScores[userData.currentLevel] < 100)) {
                speak("Complete current level with 100 points first");
                return;
            }
            clearDialogs();
            currentLevel = level;
            setScreen("gameScreen");
            document.getElementById("gameLevel").textContent = currentLevel;
            score = 0;
            totalTime = 180;
            turnTime = 5;
            isGamePaused = false;
            isGameActive = true;
            lastSpokenScore = 0;
            startTime = Date.now();
            updateUI();
            updatePauseButton();
            audioElements.mainScreen.pause();
            audioElements.bgm.play().catch(err => console.error("BGM Error:", err));
            playCue();
            gameInterval = setInterval(gameLoop, 1000);
            document.addEventListener("touchstart", handleTouchStart, { passive: false });
            document.addEventListener("touchend", handleTouchEnd, { passive: false });
            document.addEventListener("keydown", handleKeyDown);
            speak(`Game started, level ${currentLevel}`);
        };

        const gameLoop = () => {
            if (!isGamePaused && isGameActive) {
                totalTime--;
                updateUI();
                if (totalTime <= 10 && totalTime > 0) audioElements.alert.play();
                if (totalTime <= 0) {
                    endGame(score >= 80);
                }
            }
        };

        const turnLoop = () => {
            if (!isGamePaused && isGameActive) {
                turnTime--;
                updateUI();
                if (turnTime <= 0) handleGesture("none");
            }
        };

        const updatePauseButton = () => {
            const pauseButton = document.getElementById("pauseButton");
            if (isGamePaused) {
                pauseButton.textContent = "Resume Game";
                pauseButton.setAttribute("aria-label", "Resume Game");
            } else {
                pauseButton.textContent = "Pause";
                pauseButton.setAttribute("aria-label", "Pause Game");
            }
        };

        const toggleGamePause = () => {
            if (!isGameActive) return;
            isGamePaused = !isGamePaused;
            audioElements.pause.play();
            audioElements.bgm[isGamePaused ? "pause" : "play"]();
            updatePauseButton();
            speak(isGamePaused ? "Game paused" : "Game resumed");
        };

        const endGame = (won) => {
            clearInterval(gameInterval);
            clearInterval(turnInterval);
            isGameActive = false;
            audioElements.bgm.pause();
            Object.values(audioElements).forEach(audio => audio.pause());
            const timeTaken = (Date.now() - startTime) / 1000;
            userData.totalTimeTaken += timeTaken;
            userData.gamesPlayed++;
            userData.levelScores[currentLevel] = Math.max(userData.levelScores[currentLevel] || 0, score);
            if (won && score >= 80) {
                userData.matchesWon++;
                if (score >= 100) {
                    userData.currentLevel = Math.min(currentLevel + 1, maxLevels);
                    audioElements.win.play();
                    speak(`Level ${currentLevel} complete! Advancing to level ${userData.currentLevel}`);
                } else {
                    audioElements.win.play();
                    speak(`You won with ${score} points, but need 100 to advance.`);
                }
            } else {
                userData.matchesLost++;
                audioElements.fall.play();
            }
            userData.totalScore += score;
            saveUserData();
            showResultDialog(won);
            document.removeEventListener("touchstart", handleTouchStart);
            document.removeEventListener("touchend", handleTouchEnd);
            document.removeEventListener("keydown", handleKeyDown);
        };

        const showResultDialog = (won) => {
            clearDialogs();
            setScreen("none");
            const backdrop = document.createElement("div");
            backdrop.className = "dialogBackdrop";
            document.body.appendChild(backdrop);
            const modal = document.createElement("div");
            modal.className = "floatingDialog";
            const message = won && score >= 80 ? 
                winMessages[Math.floor(Math.random() * winMessages.length)] : 
                loseMessages[Math.floor(Math.random() * loseMessages.length)];
            modal.innerHTML = `
                <h2>${message}</h2>
                <p>Score: ${score}</p>
                ${won && score >= 100 && currentLevel < maxLevels ? `<button onclick="startGame(${currentLevel + 1})">Next Level (${currentLevel + 1})</button>` : ""}
                <button onclick="startGame(${currentLevel})">Retry Level ${currentLevel}</button>
                <button onclick="backToMainMenu()">Main Menu</button>
            `;
            document.body.appendChild(modal);
            speak(`${message}, score ${score}`);
        };

        const backToMainMenu = () => {
            clearDialogs();
            setScreen("mainScreen");
            audioElements.mainScreen.currentTime = 0;
            audioElements.mainScreen.play().catch(err => console.error("Main Screen Audio Error:", err));
            updateMainScreen();
            speak("Back to main menu");
        };

        const updateUI = () => {
            document.getElementById("score").textContent = `Score: ${score}`;
            document.getElementById("timer").textContent = `Time Left: ${totalTime}s`;
            document.getElementById("turnTimer").textContent = `Turn Time: ${turnTime}s`;
            document.getElementById("progress").style.width = `${(totalTime / 180) * 100}%`;
            checkScoreForTTS();
        };

        const checkScoreForTTS = () => {
            const crossedThreshold = Math.floor(score / 4) !== Math.floor(lastSpokenScore / 4);
            const signChange = (score < 0 && lastSpokenScore >= 0) || (score >= 0 && lastSpokenScore < 0);
            if (crossedThreshold || signChange) {
                speak(`Score ${score}`);
                lastSpokenScore = score;
            }
        };

        const handleTouchStart = (e) => {
            if (!isAudioPlaying && isGameActive) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                e.preventDefault();
            }
        };

        const handleTouchEnd = (e) => {
            if (!isAudioPlaying && isGameActive) {
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                detectSwipe();
                e.preventDefault();
            }
        };

        const detectSwipe = () => {
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            let detectedGesture = "";
            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 50) detectedGesture = "right";
                else if (diffX < -50) detectedGesture = "left";
            } else {
                if (diffY > 50) detectedGesture = "down";
                else if (diffY < -50) detectedGesture = "up";
            }
            if (detectedGesture) handleGesture(detectedGesture);
        };

        const handleGesture = (gesture) => {
            if (isAudioPlaying || !isGameActive) return;
            clearInterval(turnInterval);
            if (gesture === currentCues[swipeCount]) {
                score += 1.5;
                userData.correctSwipes++;
                audioElements.success.play();
                swipeArea.style.backgroundColor = "var(--success-bg)";
                setTimeout(() => swipeArea.style.backgroundColor = "var(--swipe-area)", 500);
                swipeCount++;
                if (swipeCount === currentCues.length) {
                    if (score >= 100) endGame(true);
                    else playCue();
                }
            } else {
                score = Math.max(0, score - 0.5);
                userData.missedSwipes++;
                audioElements.fail.play();
                swipeArea.style.backgroundColor = "var(--fail-bg)";
                setTimeout(() => swipeArea.style.backgroundColor = "var(--swipe-area)", 500);
                playCue();
            }
            updateUI();
        };

        const handleKeyDown = (e) => {
            if (isAudioPlaying || !isGameActive) return;
            if (document.getElementById("gameScreen").classList.contains("active") && !isGamePaused) {
                switch (e.key) {
                    case "ArrowUp": handleGesture("up"); break;
                    case "ArrowDown": handleGesture("down"); break;
                    case "ArrowLeft": handleGesture("left"); break;
                    case "ArrowRight": handleGesture("right"); break;
                }
            }
        };

        const showOptions = () => {
            setScreen("optionsScreen");
            audioElements.mainScreen.pause();
            speak("Options menu opened");
        };

        const hideOptions = () => {
            setScreen("mainScreen");
            audioElements.mainScreen.currentTime = 0;
            audioElements.mainScreen.play().catch(err => console.error("Main Screen Audio Error:", err));
            speak("Back to main menu");
        };

        const showUserProfile = () => {
            setScreen("profileScreen");
            document.getElementById("userName").value = userData.name;
            const avgTime = userData.gamesPlayed ? (userData.totalTimeTaken / userData.gamesPlayed).toFixed(2) : 0;
            const winPercentage = userData.gamesPlayed ? ((userData.matchesWon / userData.gamesPlayed) * 100).toFixed(2) : 0;
            const accuracy = (userData.correctSwipes + userData.missedSwipes) > 0 ? 
                ((userData.correctSwipes / (userData.correctSwipes + userData.missedSwipes)) * 100).toFixed(2) : 0;
            let levelScoresHTML = "";
            for (let i = 1; i <= maxLevels; i++) {
                levelScoresHTML += `<p>Level ${i} Best Score: ${userData.levelScores[i] || 0}</p>`;
            }
            document.getElementById("profileStats").innerHTML = `
                <p>Name: ${userData.name}</p>
                <p>Current Level: ${userData.currentLevel}</p>
                <p>Correct Swipes: ${userData.correctSwipes}</p>
                <p>Missed Swipes: ${userData.missedSwipes}</p>
                <p>Swipe Accuracy: ${accuracy}%</p>
                <p>Total Score: ${userData.totalScore}</p>
                <p>Matches Won: ${userData.matchesWon}</p>
                <p>Matches Lost: ${userData.matchesLost}</p>
                <p>Win Percentage: ${winPercentage}%</p>
                <p>Games Played: ${userData.gamesPlayed}</p>
                <p>Average Time per Game: ${avgTime}s (${((avgTime / 180) * 100).toFixed(2)}%)</p>
                ${levelScoresHTML}
                <p>Tip: Improve your accuracy and speed to boost your stats!</p>
            `;
            speak("Profile opened");
        };

        const saveProfile = () => {
            userData.name = document.getElementById("userName").value.trim() || "Player";
            saveUserData();
            hideProfile();
            speak("Profile saved");
        };

        const hideProfile = () => {
            setScreen("optionsScreen");
            speak("Back to options");
        };

        const deleteProfile = () => {
            if (confirm("Reset all stats and custom sounds? This will delete all saved data.")) {
                userData = {
                    name: "Player",
                    currentLevel: 1,
                    correctSwipes: 0,
                    missedSwipes: 0,
                    totalScore: 0,
                    matchesWon: 0,
                    matchesLost: 0,
                    totalTimeTaken: 0,
                    gamesPlayed: 0,
                    levelScores: {},
                    customSounds: {},
                    volumes: {}
                };
                localStorage.removeItem("gestureMindUserData");
                resetAudioToDefault();
                hideProfile();
                speak("Profile deleted and reset");
            }
        };

        const resetAudioToDefault = () => {
            for (const [key, src] of Object.entries(defaultAudioSources)) {
                audioElements[key].src = src;
                audioElements[key].volume = 1; // Reset to default volume
            }
            userData.customSounds = {};
            userData.volumes = {};
            saveUserData();
        };

        const showTutorial = () => {
            setScreen("tutorialScreen");
            let content = "";
            for (const [section, data] of Object.entries(tutorialData)) {
                content += `<h3>${data.title}</h3><p>${data.description}</p>`;
                if (data.details) {
                    content += "<ul>";
                    data.details.forEach(item => {
                        if (item.action) {
                            content += `<li><strong>${item.action}</strong>: ${item.purpose} (Cue: ${item.cue})</li>`;
                        } else if (item.rule) {
                            content += `<li><strong>${item.rule}</strong>: ${item.description}</li>`;
                        } else if (item.screen) {
                            content += `<li><strong>${item.screen}</strong>: ${item.description}</li>`;
                        } else if (item.tip) {
                            content += `<li><strong>${item.tip}</strong>: ${item.description}</li>`;
                        }
                    });
                    content += "</ul>";
                }
            }
            document.getElementById("tutorialContent").innerHTML = content;
            speak("Tutorial opened");
        };

        const hideTutorial = () => {
            setScreen("mainScreen");
            audioElements.mainScreen.currentTime = 0;
            audioElements.mainScreen.play().catch(err => console.error("Main Screen Audio Error:", err));
            speak("Back to main menu");
        };

        const populateVolumeDropdowns = () => {
            const options = [];
            for (let i = 0; i <= 100; i += 5) {
                options.push(`<option value="${i / 100}">${i}%</option>`);
            }
            document.querySelectorAll(".audio-setting select").forEach(select => {
                select.innerHTML = options.join("");
                select.value = userData.volumes[select.id.replace("Volume", "")] || "1"; // Load saved volume or default to 100%
            });
        };

        const previewAudio = (key) => {
            const audio = audioElements[key];
            audio.currentTime = 0;
            audio.play().then(() => {
                document.getElementById(`${key}Pause`).style.display = "inline";
            }).catch(err => console.error(`Preview Error for ${key}:`, err));
        };

        const pausePreview = (key) => {
            const audio = audioElements[key];
            audio.pause();
            document.getElementById(`${key}Pause`).style.display = "none";
        };

        const removeCustomSound = (key) => {
            audioElements[key].src = defaultAudioSources[key];
            delete userData.customSounds[key];
            saveUserData();
            speak(`Custom ${key} sound removed`);
        };

        const showSoundSettings = () => {
            setScreen("soundSettingsScreen");
            const settings = [
                { id: "bgm", element: audioElements.bgm },
                { id: "mainScreen", element: audioElements.mainScreen },
                { id: "pause", element: audioElements.pause },
                { id: "reset", element: audioElements.reset },
                { id: "swipeUp", element: audioElements.up },
                { id: "swipeDown", element: audioElements.down },
                { id: "swipeLeft", element: audioElements.left },
                { id: "swipeRight", element: audioElements.right },
                { id: "success", element: audioElements.success },
                { id: "fail", element: audioElements.fail },
                { id: "alert", element: audioElements.alert },
                { id: "win", element: audioElements.win },
                { id: "fall", element: audioElements.fall }
            ];
            settings.forEach(({ id, element }) => {
                const volumeSelect = document.getElementById(`${id}Volume`);
                const fileInput = document.getElementById(`${id}File`);
                volumeSelect.value = userData.volumes[id] || element.volume;
                volumeSelect.onchange = (e) => {
                    element.volume = parseFloat(e.target.value);
                    userData.volumes[id] = element.volume;
                    saveUserData();
                };
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith("audio/")) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = event.target.result;
                            element.src = dataUrl;
                            userData.customSounds[id] = dataUrl;
                            saveUserData();
                            speak(`Custom ${id} sound uploaded and saved`);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        speak("Please upload a valid audio file");
                    }
                };
            });
            document.getElementById("bgmLoop").onchange = (e) => {
                audioElements.bgm.loop = e.target.checked;
                saveUserData();
            };
            document.getElementById("bgmLoop").checked = audioElements.bgm.loop;
            speak("Sound settings opened");
        };

        const hideSoundSettings = () => {
            setScreen("optionsScreen");
            Object.values(audioElements).forEach(audio => audio.pause());
            document.querySelectorAll(".audio-setting button[id$='Pause']").forEach(btn => btn.style.display = "none");
            speak("Back to options");
        };

        const updateMainScreen = () => {
            document.getElementById("currentLevelDisplay").textContent = `Current Level: ${userData.currentLevel}`;
            const continueButton = document.getElementById("continueButton");
            if (userData.currentLevel > 1 && userData.currentLevel <= maxLevels) {
                continueButton.style.display = "block";
                continueButton.textContent = `Continue with Level ${userData.currentLevel}`;
            } else {
                continueButton.style.display = "none";
            }
        };

        const playMainScreenAudio = () => {
            audioElements.mainScreen.currentTime = 0;
            audioElements.mainScreen.play().catch(err => console.error("Main Screen Audio Error:", err));
        };

        const init = () => {
            loadUserData();
            populateVolumeDropdowns();
            setScreen("mainScreen");
            playMainScreenAudio();
            speak("Welcome to GestureMind");
        };

        window.onload = init;

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible" && document.getElementById("mainScreen").classList.contains("active")) {
                playMainScreenAudio();
            }
        });
    </script>
</body>
</html>