<!DOCTYPE html>

<html> 
    <head> <title>Shootout Challenge</title> <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script> <style> body { font-family: 'Arial', sans-serif; background-color: #222; color: #eee; text-align: center; margin: 0; padding: 0; overflow: hidden; }
 
    h1 {
        margin-top: 20px;
        color: #ddd;
    }

    #initialScreen {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(34, 34, 34, 0.8);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }

    #initialScreen p {
        font-size: 20px;
        margin-bottom: 20px;
    }

    #modeSelection {
        margin-top: 20px;
    }

    #modeSelection button {
        background-color: #5cb85c;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 22px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
        margin: 5px;
    }

    #modeSelection button:hover {
        background-color: #449d44;
    }

    #onlineSetup {
        display: none;
        margin-top: 20px;
    }

    #onlineSetup input[type="text"],
    #onlineSetup button {
        padding: 10px;
        margin: 5px;
        font-size: 18px;
    }

    #start-btn {
        background-color: #5cb85c;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 22px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    #start-btn:hover {
        background-color: #449d44;
    }

    #game-area {
        margin: 20px auto;
        padding: 30px;
        max-width: 600px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid #555;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        display: none;
        position: relative;
    }

    #controls {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    .shoot-btn {
        background-color: #337ab7;
        color: white;
        padding: 15px 30px;
        font-size: 24px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        margin: 0 10px;
        transition: background-color 0.3s;
        width: 120px;
    }

    .shoot-btn:hover {
        background-color: #235a81;
    }

    #pause-btn {
        background-color: #ffcc00;
        border: none;
        padding: 12px 24px;
        font-size: 20px;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    #pause-btn:hover {
        background-color: #e6b800;
    }

    #scoreboard {
        margin-top: 20px;
        font-size: 28px;
        font-weight: bold;
        color: #fff;
    }

    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .loader {
        border: 16px solid #f3f3f3;
        border-top: 16px solid #3498db;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    #endGameScreen {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(34, 34, 34, 0.8);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        text-align: center;
        display: none;
    }

    #endGameScreen h2 {
        color: #fff;
        margin-bottom: 20px;
    }

    #endGameScreen button {
        background-color: #5cb85c;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 22px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
        margin-top: 20px;
    }

    #endGameScreen button:hover {
        background-color: #449d44;
    }

    #player,
    #enemy {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 20px auto;
        background-color: #4CAF50;
        border-radius: 50%;
        transition: transform 0.3s ease;
    }

    #player.shoot-left {
        transform: translateX(-150px);
    }

    #player.shoot-center {
        transform: translateX(0);
    }

    #player.shoot-right {
        transform: translateX(150px);
    }

    #enemy.attack-left {
        transform: translateX(-150px);
    }

    #enemy.attack-center {
        transform: translateX(0);
    }

    #enemy.attack-right {
        transform: translateX(150px);
    }

    .obstacle {
        position: absolute;
        width: 50px;
        height: 50px;
        background-color: #f44336;
        border-radius: 50%;
    }

    #waitingScreen {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(34, 34, 34, 0.8);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        text-align: center;
        display: none;
    }

    #hostIdDisplay {
        margin-top: 10px;
        font-size: 16px;
        color: #ddd;
    }

    #copyHostId {
        background-color: #007BFF;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 14px;
    }

    #copyHostId:hover {
        background-color: #0056b3;
    }

    #peerIdInput {
        display: inline-block;
    }

    button,
    input[type="text"] {
        font-size: 1.2em;
        padding: 0.5em;
    }

    button:focus,
    input[type="text"]:focus {
        outline: 2px solid yellow;
    }
</style>
</head> <body onload="playMainScreenAudio()"> <div id="loading-overlay"> <div class="loader"></div> </div>
 
<h1>Shootout Challenge</h1>

<div id="initialScreen">
    <p>Welcome to the Shootout Challenge! Get ready!</p>
    <div id="modeSelection">
        <button onclick="setupBotGame()">Play with Bot</button>
        <button onclick="setupOnlineGame(true)">Host Game</button>
        <button onclick="setupOnlineGame(false)">Join Game</button>
    </div>
    <div id="onlineSetup">
        <p>Enter Host ID:</p>
        <input type="text" id="peerIdInput" placeholder="Host ID">
        <button onclick="connectToPeer()">Connect</button>
    </div>
    <div id="hostIdDisplay">
        Your Host ID: <span id="myPeerId"></span>
        <button id="copyHostId" onclick="copyToClipboard()" style="display:none;">Copy ID</button>
    </div>
</div>

<div id="game-area" style="display: none;">
    <div id="player"></div>
    <div id="enemy"></div>
    <div id="controls">
        <button class="shoot-btn" data-direction="left">Shoot Left</button>
        <button class="shoot-btn" data-direction="center">Shoot Center</button>
        <button class="shoot-btn" data-direction="right">Shoot Right</button>
    </div>
    <button id="pause-btn" onclick="togglePause()">Pause Game</button>
    <div id="scoreboard">
        Player: <span id="player-score">0</span> | Enemy: <span id="enemy-score">0</span>
    </div>
</div>

<div id="endGameScreen" style="display: none;">
    <h2 id="endGameMessage"></h2>
    <button onclick="resetGame()">Play Again</button>
</div>

<div id="waitingScreen" style="display: none;">
    <p>Waiting for opponent... Please share this Host ID: <span id="waitingPeerId"></span>
        <button id="copyWaitingId" onclick="copyGameIdToClipboard()">Copy ID</button>
    </p>
</div>

<script>
    let peer;
    let peerId;
    let conn;
    let isHost = false;
    let isOnlineGame = false;
    let playerScore = 0;
    let enemyScore = 0;
    let enemyDirection = "";
    let enemyTimeout;
    let gameInterval;
    let isPaused = false;
    let enemyAttacked = false;
    const enemyDirections = ['left', 'center', 'right'];
    let mainScreenAudio;
    let volumeBeforeGame;
    let canShoot = true;
    let timeBetweenAttacks = 6800;
    let attackDelay = 3000;
    let playerTurn = true;
    let shotTimer;
    let shotsRemaining = 10;
    let botGameInterval;
    let noShotTimer;

    const audioFiles = {
        mainScreen: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Main%20screen.mp3',
        gameStart: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/game%20start%20sound%20effect.mp3',
        left: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/left.mp3',
        center: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/centre.mp3',
        right: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/right.mp3',
        playerHit: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/achievement-bell1.mp3',
        enemyHit: 'https://www.myinstants.com/media/sounds/gun.mp3',
        win: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/win_1.mp3',
        lose: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Loose%20game.mp3',
        buttonPress: 'https://www.myinstants.com/media/sounds/mouse-click.mp3',
        playerShoot: 'https://www.myinstants.com/media/sounds/gun.mp3',
        enemyAlert: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/reset.mp3',
        draw: 'https://www.myinstants.com/media/sounds/crowd-cheering.mp3',
        clap: 'https://www.myinstants.com/media/sounds/applause.mp3',
        newWave: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/New%20wave.mp3',
        obstacle: 'https://github.com/Interestingtechforvi/Home/raw/refs/heads/main/Beep%20sound%20effect.mp3'
    };

    const preloadedAudio = {};

    const preloadAudio = (url) => {
        return new Promise((resolve, reject) => {
            const audio = new Audio();
            audio.src = url;
            audio.addEventListener('canplaythrough', () => {
                preloadedAudio[url] = audio;
                resolve(audio);
            });
            audio.addEventListener('error', () => {
                reject(new Error(`Failed to load audio ${url}`));
            });
        });
    };

    const playAudio = (url) => {
        if (preloadedAudio[url]) {
            const audio = preloadedAudio[url];
            audio.currentTime = 0;
            audio.play();
        } else {
            console.warn(`Audio not preloaded: ${url}`);
        }
    };

    function playMainScreenAudio() {
        mainScreenAudio = new Audio(audioFiles.mainScreen);
        mainScreenAudio.loop = true;
        mainScreenAudio.volume = 1;
        mainScreenAudio.play();
    }

    function stopMainScreenAudio() {
        if (mainScreenAudio) {
            mainScreenAudio.pause();
            mainScreenAudio.currentTime = 0;
        }
    }

    function setVolume(audio, volume) {
        if (audio && audio.volume !== undefined) {
            audio.volume = volume;
        }
    }

    function copyToClipboard() {
        const textToCopy = document.getElementById('myPeerId').textContent;
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                alert('Host ID copied!');
                speak("Host ID copied!");
            })
            .catch(err => {
                console.error('Failed to copy: ', err);
                alert('Oops, failed to copy Host ID. Please copy manually.');
                speak("Oops, failed to copy Host ID. Please copy manually.");
            });
        playAudio(audioFiles.buttonPress);
    }

    function setupBotGame() {
        isOnlineGame = false;
        document.getElementById('onlineSetup').style.display = 'none';
        startGame();
        startBotGame();
        speak("Starting game with Bot");
    }

    function startBotGame() {
        document.getElementById('initialScreen').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        isOnlineGame = false;

        if (mainScreenAudio) {
            volumeBeforeGame = mainScreenAudio.volume;
            setVolume(mainScreenAudio, volumeBeforeGame * 0.4);
        }

        stopMainScreenAudio();
        playAudio(audioFiles.gameStart);
        speak("Game Starting with Bot!");

        playerTurn = true;
        canShoot = true;
        shotsRemaining = 10;
        updateShotsRemainingDisplay();

        startEnemyAppearance();
    }

    function setupOnlineGame(host) {
        isOnlineGame = true;
        isHost = host;
        document.getElementById('onlineSetup').style.display = !host;

        peer = new Peer();

        peer.on('open', (id) => {
            peerId = id;
            document.getElementById('myPeerId').textContent = id;
            console.log('My Peer ID is: ' + id);
            document.getElementById('copyHostId').style.display = 'inline-block';

            if (isHost) {
                startHosting();
                speak("You are the host. Waiting for someone to join.");
            } else {
                document.getElementById('initialScreen').style.display = 'block';
                document.getElementById('onlineSetup').style.display = 'block';
                speak("Enter the Host ID to connect");
            }
        });

        peer.on('connection', (connection) => {
            conn = connection;
            console.log("Connected to peer!");
            stopWaitingScreen();
            startOnlineGame();
            speak("Connected to opponent. Game starting!");

            conn.on('data', (data) => {
                handleOpponentData(data);
            });

            conn.on('close', () => {
                endGame("Opponent Disconnected!");
                speak("Opponent Disconnected!");
            });

            conn.on('error', (err) => {
                console.error(err);
                alert("Connection error. Let me check the console for details.");
                speak("Connection error. Please check the console.");
                endGame("Connection Error!");
            });
        });

        peer.on('disconnected', () => {
            console.log("Disconnected!");
            endGame("Disconnected from Opponent!");
            speak("Disconnected from Opponent!");
        });

        peer.on('error', (err) => {
            console.error(err);
            alert("PeerJS error!");
            endGame("PeerJS Error!");
            speak("PeerJS Error!");
        });
    }

    function startHosting() {
        document.getElementById('initialScreen').style.display = 'none';
        document.getElementById('waitingScreen').style.display = 'block';
        document.getElementById('waitingPeerId').textContent = peerId;
        document.getElementById('copyHostId').style.display = 'none';
        console.log("Hosting game with ID: " + peerId);
        speak("Hosting game. Waiting for opponent to connect.");
    }

    function connectToPeer() {
        const peerIdToConnect = document.getElementById('peerIdInput').value;
        document.getElementById('onlineSetup').style.display = 'none';

        if (peer) {
            conn = peer.connect(peerIdToConnect);

            conn.on('open', () => {
                console.log("Connected to peer: " + peerIdToConnect);
                stopWaitingScreen();
                startOnlineGame();
                speak("Connected to opponent. Game starting!");
            });

            conn.on('data', (data) => {
                handleOpponentData(data);
            });

            conn.on('close', () => {
                endGame("Opponent Disconnected!");
                speak("Opponent Disconnected!");
            });

            conn.on('error', (err) => {
                console.error(err);
                alert("Connection error!");
                endGame("Connection Failed!");
                speak("Connection Failed!");
            });
        } else {
            alert("PeerJS not initialized!");
            speak("PeerJS not initialized!");
        }
    }

    function startGame() {
        document.getElementById('initialScreen').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';

        if (mainScreenAudio) {
            volumeBeforeGame = mainScreenAudio.volume;
            setVolume(mainScreenAudio, volumeBeforeGame * 0.4);
        }

        stopMainScreenAudio();
        playAudio(audioFiles.gameStart);
    }

    function startOnlineGame() {
        document.getElementById('initialScreen').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('onlineSetup').style.display = 'none';
        isOnlineGame = true;

        if (mainScreenAudio) {
            volumeBeforeGame = mainScreenAudio.volume;
            setVolume(mainScreenAudio, volumeBeforeGame * 0.4);
        }

        stopMainScreenAudio();
        playAudio(audioFiles.gameStart);
        speak("Online Game Starting!");

        if (isHost) {
            speak("Your turn to shoot first!");
        } else {
            speak("Opponent's turn to shoot first. Get ready to defend!");
        }

        shotsRemaining = 10;
        updateShotsRemainingDisplay();

        if (isHost) {
            startPlayerTurn();
        } else {
            startEnemyAppearance(); // Start enemy appearance for the joining player
        }
    }

    function updateShotsRemainingDisplay() {
        console.log(`Shots Remaining: ${shotsRemaining}`);
    }

    function startPlayerTurn() {
        playerTurn = true;
        canShoot = true;
        shotsRemaining = 10;
        updateShotsRemainingDisplay();
        speak("Your turn! Listen for the enemy position.");
        startEnemyAppearance();
    }

    function startEnemyAppearance() {
        if (gameInterval) {
            clearInterval(gameInterval);
        }

        gameInterval = setInterval(() => {
            if (!isPaused && playerTurn) {
                enemyDirection = enemyDirections[Math.floor(Math.random() * 3)];
                playDirectionAudio(enemyDirection);

                // Clear any existing timer
                clearTimeout(noShotTimer);

                // Set a new timer for enemy auto-shoot
                noShotTimer = setTimeout(() => {
                    if (playerTurn && shotsRemaining > 0) {
                        speak("Time's up! Enemy shoots automatically.");
                        enemyShootsAutomatically();
                    }
                }, attackDelay);
            }
        }, timeBetweenAttacks);
    }

    function enemyShootsAutomatically() {
        clearTimeout(shotTimer);
        clearTimeout(noShotTimer); // Clear the no-shot timer
        if (!playerTurn) return;

        playerTurn = false;
        canShoot = false;

        if (conn) {
            conn.send({
                type: 'enemyShoot',
                direction: enemyDirection
            });
        }
        simulateEnemyShoot(enemyDirection);

        setTimeout(() => {
            if (conn) {
                sendData({
                    type: "endTurn",
                });
            }
            speak("your turn! Get Ready");
            startPlayerTurn();
        }, 3000);

    }

    function playDirectionAudio(direction) {
        let audioUrl;
        switch (direction) {
            case 'left':
                audioUrl = audioFiles.left;
                break;
            case 'center':
                audioUrl = audioFiles.center;
                break;
            case 'right':
                audioUrl = audioFiles.right;
                break;
        }

        if (audioUrl) {
            playAudio(audioUrl);
        }
    }

    document.querySelectorAll('.shoot-btn').forEach(button => {
        button.onclick = () => {
            if (isPaused || !playerTurn || !canShoot) {
                return;
            }

            playAudio(audioFiles.buttonPress);
            const direction = button.dataset.direction;
            shoot(direction);
        };
    });

    function shoot(direction) {
        clearTimeout(shotTimer);
        clearTimeout(noShotTimer); // Clear the no-shot timer

        if (playerTurn && canShoot) {
            canShoot = false;
            playerTurn = false;

            playAudio(audioFiles.playerShoot);
            const player = document.getElementById('player');
            player.classList.add(`shoot-${direction}`);
            let hit = false;

            if (enemyDirection === direction) {
                playerScore++;
                document.getElementById('player-score').textContent = playerScore;
                playAudio(audioFiles.playerHit);
                speak("Player scores!");
                hit = true;
                if (navigator.vibrate) {
                    navigator.vibrate(500);
                }
            }

            if (conn) {
                sendData({
                    type: 'shoot',
                    direction: direction,
                    hit: hit,
                    enemyDirection: enemyDirection
                });
            }

            checkWinner();

            setTimeout(() => {
                player.classList.remove(`shoot-${direction}`);

                setTimeout(() => {
                    canShoot = true;
                }, 500);
            }, 300);
            shotsRemaining--;
            updateShotsRemainingDisplay();

            setTimeout(() => {
                if (conn) {
                    sendData({
                        type: "endTurn",
                    });
                }
                speak("your turn! Get Ready");
                startPlayerTurn();
            }, 3000);
        }
    }

    function handleOpponentData(data) {
        if (data && data.type === 'shoot') {
            simulateOpponentShoot(data.direction, data.hit);
        } else if (data && data.type === 'enemyShoot') {
            simulateEnemyShoot(data.direction);
        } else if (data && data.type === "endTurn") {
            console.log("end turn message received");
            startPlayerTurn();
        }
    }

    function simulateOpponentShoot(direction, hit) {
        const enemy = document.getElementById('enemy');
        enemy.classList.add(`attack-${direction}`);

        setTimeout(() => {
            enemy.classList.remove(`attack-${direction}`);
            if (hit) {
                enemyScore++;
                document.getElementById('enemy-score').textContent = enemyScore;
                playAudio(audioFiles.enemyHit);
                speak("Enemy scores!");
                if (navigator.vibrate) {
                    navigator.vibrate(500);
                }
            }
            checkWinner();
        }, 500);

        canShoot = true;
    }

    function simulateEnemyShoot(direction) {
        // Play enemy hit sound when the enemy scores automatically
        playAudio(audioFiles.enemyHit);
        if (direction === enemyDirection) {
            enemyScore++; // Corrected this line to increment enemyScore
            document.getElementById('enemy-score').textContent = enemyScore;
            playAudio(audioFiles.playerHit);
            speak("Enemy scores!");
            checkWinner();
        }
    }

    function checkWinner() {
        if (playerScore >= 10) {
            endGame("You Win!");
            playAudio(audioFiles.win);
            speak("You Win!");
        } else if (enemyScore >= 10) {
            endGame("Enemy Wins!");
            playAudio(audioFiles.lose);
            speak("Enemy Wins!");
        }
    }

    function endGame(message) {
        clearInterval(gameInterval);
        clearTimeout(shotTimer);
        clearTimeout(noShotTimer);  // Clear the no-shot timer
        clearInterval(botGameInterval);

        document.getElementById('endGameMessage').textContent = message;
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('endGameScreen').style.display = 'block';
        speak(message);

        if (message === "You Win!") {
            playAudio(audioFiles.clap);
            document.getElementById('endGameMessage').textContent = "Hurray! You Win!";
        }

        if (conn) {
            conn.close();
            conn = null;
        }

        if (peer) {
            peer.destroy();
            peer = null;
        }
    }

    function resetGame() {
        clearInterval(gameInterval);
        clearTimeout(shotTimer);
        clearTimeout(noShotTimer);  // Clear the no-shot timer
        clearInterval(botGameInterval);

        if (mainScreenAudio) {
            setVolume(mainScreenAudio, volumeBeforeGame);
        }

        document.getElementById('endGameScreen').style.display = 'none';
        document.getElementById('initialScreen').style.display = 'block';
        document.getElementById('onlineSetup').style.display = 'none';
        speak("Starting a new game!");

        playMainScreenAudio();
        playerScore = 0;
        enemyScore = 0;
        document.getElementById('player-score').textContent = playerScore;
        document.getElementById('enemy-score').textContent = enemyScore;
    }

    function togglePause() {
        isPaused = !isPaused;

        document.getElementById('pause-btn').textContent = isPaused ? "Resume Game" : "Pause Game";
        speak(isPaused ? "Game Paused" : "Game Resumed");

        if (!isPaused) {
            startEnemyAppearance();
        } else {
            clearInterval(gameInterval);
            clearTimeout(shotTimer);
            clearTimeout(noShotTimer);  // Clear the no-shot timer
        }
    }

    function sendData(data) {
        if (conn) {
            conn.send(data);
        }
    }

    function speak(text) {
        const audioUrl = `https://ar-tts.ashlynn.workers.dev/?text=${encodeURIComponent(text)}`;
        const audio = new Audio(audioUrl);
        audio.play();
    }

    function startWaitingScreen() {
        document.getElementById('initialScreen').style.display = 'none';
        document.getElementById('waitingScreen').style.display = 'block';
        document.getElementById('waitingPeerId').textContent = peerId;
    }

    function stopWaitingScreen() {
        document.getElementById('waitingScreen').style.display = 'none';
    }

    Promise.all(Object.values(audioFiles).map(preloadAudio))
        .then(() => {
            console.log('All audio preloaded!');
            document.getElementById('loading-overlay').style.display = 'none';
            alert('Welcome to shootout challenge game!');
            playMainScreenAudio();
        });
</script>
</body>
 </html>
